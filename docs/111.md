## 3. 研发面向职业教育的通用 MCP 智能体开发技术

### 一、系统总体架构

（此处插入：**MCP 架构图**）

（此处插入：**项目架构图**）

系统采用四层协同结构：

- **交互层**：提供面向用户的对话界面与任务触发入口；
- **服务编排层**：负责对话管理、模型推理、任务协调与结果汇总；
- **MCP 协议层**：承载能力协商、工具调用与跨节点通信机制；
- **基础支撑层**：包括数据存储、消息事件总线、任务监控与资源管理。

在该架构中，MCP 协议贯穿服务编排层与协议层，负责智能体节点的能力调用、通信协同与交互控制。

### 二、MCP 协议简介与系统集成

#### （1）MCP 协议架构与角色

根据 MCP 官方文档，MCP（Model Context Protocol）采用 **client-host-server 架构**，核心机制基于 JSON-RPC，实现上下文交换、能力协商与采样协调。 

- **Host（宿主/中枢）**
   负责创建与管理多个 client 实例；
     控制客户端连接权限、会话生命周期、安全策略；
     协调上下文聚合、模型调用、资源分发等事务；
- **Client**
   由 Host 创建并维护，负责与某一 Server 建立一对一的会话连接；
     处理能力协商、双向消息传递、订阅/通知机制；
     管理自身与 Server 的隔离边界与安全性；
- **Server（节点服务）**
   向 Host/Client 提供能力（tools、资源、提示模板等）接口；
     可发起采样调用；
     只接收其被允许查看的上下文片段，避免访问整体会话历史；
     可为本地或远程服务。 

设计原则包括：Server 接口简单、可组合性强、隔离性高、功能可渐进扩展。 

#### （2）能力协商 & 功能模块

在 MCP 会话初始化阶段，Client 与 Server 各自声明其**支持的能力（capabilities）**，用于能力协商与功能开启。

- **Server 能力（server features）**可能包括：工具调用、资源订阅、提示模板、状态通知等；
- **Client 能力**（如 sampling 支持、通知处理能力等）也需声明以匹配交互需求；

只有当双方都支持某项能力时，协议才允许启用对应特性。此机制保证协议的扩展性与向后兼容性。

此外，能力协商还控制以下关键流程：

- **工具调用（Tool Invocation）**：若 Server 声明支持工具能力，则 Client 可以向该 Server 发起工具请求；
- **资源订阅 / 通知（Resource Subscription / Notifications）**：Server 若声明通知支持，可向 Client 推送状态更新；
- **采样控制（Sampling）**：Client 若支持 sampling，Server 可以协调采样控制（例如中断、续采）等操作。

#### （3）系统如何集成 MCP 协议

在本系统中，MCP 协议集成如下：

1. **MCP Hub 作为 Host 实现**
   本系统的 MCP Hub Service 担任 Host 角色，负责管理多个 Client 与 Server 实例、协调能力协商、上下文聚合与工具路由。
2. **Chat 服务层作为 Client 角色**
   服务编排层中的 Chat Service 对接 MCP Hub 时，以 Client 身份向 Hub 建立连接、协商能力并向 Server 发起调用。
3. **MCP Server 作为能力提供者**
   各教学、检索、分析模块实现为 MCP Server 节点，向 Host/Client 提供工具能力、资源或提示模板。
4. **能力协商与调用流程**
   - Chat Service 向 MCP Hub Client 实例请求能力目录；
   - Hub 汇总 Server 能力并返回给客户端（Chat Service）；
   - Chat Service 根据上下文选择某个 MCP Server 发起工具调用请求；
   - Server 执行任务并通过通知机制向 Client／Hub 推送结果或确认请求；
   - Client 收到通知后更新交互状态并返回给前端。
5. **隔离与安全边界**
   每个 Client 与 Server 的连接只能访问其被授权的上下文片段，不能跨节点窥视整条对话历史。Host 负责整体安全策略与访问控制。

通过上述集成方式，本系统在服务编排层与 MCP 层之间严格遵循 MCP 协议标准，实现能力注册、能力发现、工具调用与交互协调的统一机制。

### 三、关键技术方向

（保留原稿内容）

1. 模型与工具编排
2. 工作流调度与任务管理
3. 用户引导与人机协作
4. 共享能力与数据一致性
5. 多智能体协同机制

### 四、核心流程

（此处插入：**流程图**）

核心流程如下：

1. 用户发起请求；
2. 服务编排层解析任务并作为 MCP Client 向 MCP Hub 申请能力目录；
3. MCP Hub 汇总各 MCP Server 能力并返回给 Client；
4. Client（Chat 服务层）根据任务需求选择并向某 Server 发起工具调用；
5. Server 执行任务，并通过通知／订阅机制反馈进度、结果或补充请求；
6. Client 更新状态并将最终结果返回给用户端。

该流程构成请求 → 协商 → 调度 → 执行 → 反馈的完整闭环。